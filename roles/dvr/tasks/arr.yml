---
- name: include vault
  include_vars:
    file: vault.yml

- name: create {{ settings.groupname }} group
  group:
    name: "{{ settings.groupname }}"
    gid: "{{ settings.gid }}"
    state: present

- name: create {{ settings.username }} user
  user: 
    name: "{{ settings.username }}"
    uid: "{{ settings.uid }}"
    state: present
    group: "{{ settings.gid }}"

- name: add {{ settings.username }} to docker group
  user:
    name: "{{ settings.username }}"
    groups: docker
    append: yes
   
- name: create directories for {{ settings.username }}
  file:
   path: "{{ item }}"
   state: directory
   owner: "{{ settings.username }}"
   group: "{{ settings.groupname }}"
  with_items:
   - "/mnt/{{ settings.username }}"
   - "/mnt/{{ settings.username }}/downloads"
   - "/mnt/{{ settings.username }}/{{ settings.data_dir_name }}"

- name: add mounts to fstab {{ settings.username }} #MJS - Fix to add replace
  lineinfile:
   path: /etc/fstab
   line: "{{ item }}"
   create: yes
  with_items:
   - "//{{ media_nas_name }}/{{ settings.smb_dir }} /mnt/{{ settings.username }}/{{ settings.data_dir_name }} cifs username={{ settings.smb_creds.username }},password={{ settings.smb_creds.password }},iocharset=utf8,uid={{ settings.uid }},gid={{ settings.gid }},file_mode=0755,dir_mode=0755,vers=3.1.1"
   - "//{{ media_nas_name }}/nzb/downloads /mnt/{{ settings.username }}/downloads cifs username={{ settings.smb_creds.username }},password={{ settings.smb_creds.password }},iocharset=utf8,uid={{ settings.uid }},gid={{ settings.gid }},file_mode=0755,dir_mode=0755,vers=3.1.1"
  register: fstab

- name: mount all
  command: mount -a
  args:
    warn: no
  when: fstab.changed 

- name: get docker image {{ settings.image_name }} #MJS - need to update before ansible 2.12
  docker_image:
    name: "{{ settings.image_name }}"
    source: pull

- name: create directories for docker compose {{ settings.service_name }}
  file:
    path: "/{{ settings.docker_dir }}"
    state: directory
    owner: "{{ settings.uid }}"
    group: "{{ settings.gid }}"

- name: copy docker-compose file for {{ settings.service_name }}
  copy: 
    src: "{{ settings.docker_dir }}/docker-compose.yml"
    dest: "/{{ settings.docker_dir }}/docker-compose.yml"
    owner: "{{ settings.uid }}"
    group: "{{ settings.gid }}"
    remote_src: no
  register: compose_file    

- name: deploy init script for {{ settings.service_name }}
  copy:
    src: "etc/systemd/system/{{ settings.systemd_script }}"
    dest: "/etc/systemd/system/{{ settings.systemd_script }}"
  register: service_file    

- name: enable {{ settings.service_name }} service
  service:
    name: "{{ settings.service_name }}"
    state: restarted
    enabled: yes
    daemon_reload: yes
  when: compose_file.changed or service_file.changed

